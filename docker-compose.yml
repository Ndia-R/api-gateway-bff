services:
  redis:
    image: redis:8.2
    networks:
      - vsv-emerald-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  api-gateway-bff:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    ports:
      - "8888:8080"
    environment:
      TZ: Asia/Tokyo
      # Identity Provider (IdP) Configuration
      IDP_CLIENT_ID: ${IDP_CLIENT_ID}
      IDP_CLIENT_SECRET: ${IDP_CLIENT_SECRET}
      IDP_ISSUER_URI: ${IDP_ISSUER_URI}
      # BFF関連のURL（VPS_HOSTNAMEから組み立てる）
      IDP_REDIRECT_URI: https://${VPS_HOSTNAME}/bff/login/oauth2/code/idp
      IDP_POST_LOGOUT_REDIRECT_URI: https://${VPS_HOSTNAME}/logout-complete
      FRONTEND_URL: https://${VPS_HOSTNAME}
      # Application Configuration
      SERVICE_01_URL: ${SERVICE_01_URL}
      SERVICE_01_PATH_PREFIX: ${SERVICE_01_PATH_PREFIX}
      SERVICE_02_URL: ${SERVICE_02_URL}
      SERVICE_02_PATH_PREFIX: ${SERVICE_02_PATH_PREFIX}
      SERVICE_03_URL: ${SERVICE_03_URL}
      SERVICE_03_PATH_PREFIX: ${SERVICE_03_PATH_PREFIX}
      SERVICE_04_URL: ${SERVICE_04_URL}
      SERVICE_04_PATH_PREFIX: ${SERVICE_04_PATH_PREFIX}
      SERVICE_05_URL: ${SERVICE_05_URL}
      SERVICE_05_PATH_PREFIX: ${SERVICE_05_PATH_PREFIX}
      # Logging Settings
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
    volumes:
      - .:/workspace
      - gradle-cache:/home/vscode/.gradle
      - claude-config:/home/vscode/.claude
      - gemini-config:/home/vscode/.gemini
    networks:
      - vsv-emerald-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    depends_on:
      redis:
        condition: service_healthy
    command: sleep infinity

volumes:
  gradle-cache:
  claude-config:
  gemini-config:

networks:
  vsv-emerald-network:
    external: true